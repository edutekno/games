---
layout: post
title:  å¿«é€Ÿæ­å»ºAlgo VPN
date:   2018-01-19 21:00:17 +0000
author: xgan
categories: tutorial
---

# Algo VPN
è€å¤§å“¥è¯´è¯ç®—è¯ï¼Œæœ€è¿‘å›½å†…å¾ˆå¤šVPNæœç„¶éƒ½è¢«å°æ‰äº†ï¼Œæˆ‘ç­‰å±æ°‘ä¸ºäº†èƒ½å¥½å¥½å†™ä»£ç ä¸å¾—ä¸æƒ³åŠæ³•è‡ªå·±å¼„ä¸ªVPNã€‚ åœ¨çœ‹äº†ä¸å°‘ç½‘ä¸Šçš„æ•™ç¨‹ï¼Œå‘ç°ç”¨ [Algo VPN](https://github.com/trailofbits/algo#configure-the-vpn-clients) åº”è¯¥æ˜¯æœ€ç®€å•çš„æ–¹æ³•äº†ã€‚è¿™ä¸ªVPNçš„å¥½å¤„ï¼Œ[è¿™ç¯‡æ–‡ç« ](https://blog.trailofbits.com/2016/12/12/meet-algo-the-vpn-that-works/)è¯´äº†å¾ˆå¤šï¼Œæˆ‘å°±ä¸ä¸€ä¸€ç¿»è¯‘äº†ã€‚æˆ‘è§‰å¾—è¿™ä¸ªVPNæœ€å¤§çš„å¥½å¤„å°±æ˜¯å¯ä»¥å±è”½å¾ˆå¤šå¹¿å‘ŠğŸ˜‹ã€‚

è‡ªå·±æ­å»ºVPNå°±éœ€è¦åœ¨å›½å¤–æœ‰ä¸ªæœåŠ¡å™¨ä¹Ÿå°±æ˜¯VPSï¼Œæˆ‘è¿™é‡Œä»‹ç»ä¸€ä¸ªæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ç”¨ [DigitalOcean](https://m.do.co/c/6b87f09b0aec) çš„æœåŠ¡å™¨ï¼Œæ¯ä¸ªæœˆçš„æˆæœ¬æ˜¯ **5$**ã€‚

## æ­å»ºAlgo VPNæœåŠ¡å™¨

è™½ç„¶AlgoVPNæä¾›åœ¨ä¸åŒçš„äº‘æœåŠ¡å™¨ä¸Šä¸åŒæ­å»ºæ–¹æ³•, æ¯”å¦‚ [DigitalOcean](https://m.do.co/c/6b87f09b0aec) , [Amazon EC2](https://aws.amazon.com/), [Microsoft Azure](https://azure.microsoft.com/). ä¸‹é¢æˆ‘ç®€å•ä»‹ç»æ€ä¹ˆåœ¨ DigitalOcean ä¸Šæ­å»º:

1. **é¦–å…ˆåœ¨ [DigitalOcean](https://m.do.co/c/6b87f09b0aec) ä¸Šæ³¨å†Œä¸€ä¸ªå¸å·.**

2. **[ä¸‹è½½Algo](https://github.com/trailofbits/algo/archive/master.zip).** æŠŠä¸‹è½½çš„å‹ç¼©åŒ…è§£å‹.

3. **å®‰è£… Algo çš„ä¾èµ–åŒ….** æ‰“å¼€ä½ çš„ç»ˆç«¯. ä½ è‡³å°‘éœ€è¦å®‰è£… `python`. ç„¶å `cd` è¿›å…¥ `algo-master` è¿™ä¸ªè§£å‹å¾—åˆ°çš„æ–‡ä»¶å¤¹ , ç„¶ååœ¨ç»ˆç«¯ä¸­è¿è¡Œ:

    - macOS:
      ```bash
      $ python -m ensurepip --user
      $ python -m pip install --user --upgrade virtualenv
      ```
    - Linux (deb-based):
      ```bash
      $ sudo apt-get update && sudo apt-get install \
          build-essential \
          libssl-dev \
          libffi-dev \
          python-dev \
          python-pip \
          python-setuptools \
          python-virtualenv -y
      ```
     - Linux (rpm-based): See the [Pre-Install Documentation for RedHat/CentOS 6.x](docs/deploy-from-redhat-centos6.md)
     - Windows: See the [Windows documentation](docs/deploy-from-windows.md)

4. **å®‰è£… Algo å‰©ä¸‹çš„ä¾èµ–åŒ….** åœ¨åŒä¸€ä¸ªç»ˆç«¯ä¸‹è¿è¡Œ:
    ```bash
    $ python -m virtualenv env && source env/bin/activate && python -m pip install -U pip && python -m pip install -r requirements.txt
    ```
    åœ¨macOSä¸Šï¼Œå¯èƒ½éœ€è¦å®‰è£…`cc`ã€‚ ç›´æ¥æŒ‰ç¡®å®šï¼Œä¼šè‡ªåŠ¨å®‰è£…çš„ã€‚

5. **è®¾ç½®VPNç”¨æˆ·.** åœ¨ `config.cfg` è¿™ä¸ªæ–‡ä»¶é‡Œè®¾ç½®ç”¨æˆ·. å¦‚æœæ²¡ç”¨ç‰¹å®šçš„è®¾ç½®ï¼Œå°†ä¼šè‡ªåŠ¨ç”Ÿæˆä¸¤ä¸ªé»˜è®¤ç”¨æˆ·åã€‚

6. **å¼€å§‹æ­å»º.** åœ¨ Algo è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œï¼Œè¿è¡Œ`./algo` å°±å¯ä»¥å¼€å§‹è‡ªåŠ¨æ­å»ºVPNæœåŠ¡å™¨äº†ã€‚
   - è¿™é‡Œéœ€è¦é€‰æ‹©äº‘æœåŠ¡å™¨çš„ä½ç½®, [DigitalOcean](https://m.do.co/c/6b87f09b0aec) æä¾›å…¨çƒä¸åŒåŒºåŸŸçš„æœåŠ¡å™¨, å¦‚æœä½ ä¸»è¦åœ¨å›½å†…ä½¿ç”¨VPN, å»ºè®®é€‰æ‹©æ–°åŠ å¡æˆ–è€…å°åº¦ç­åŠ ç½—å°”çš„æ•°æ®ä¸­å¿ƒ. [å¯¹æ¯”åœ¨å›½å†…è®¿é—® DigitalOcean ä¸åŒåŒºåŸŸæœåŠ¡å™¨çš„ç½‘é€Ÿ.](https://www.91yun.co/archives/878)

![](http://upload-images.jianshu.io/upload_images/6798179-356b2d8821a37fb1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![](http://upload-images.jianshu.io/upload_images/6798179-90eb43f37506f582.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ç¬¬äºŒéƒ¨éœ€è¦åœ¨ DigitalOcean çš„è·å¾—ä¸€ä¸ªAPI token.

![](http://upload-images.jianshu.io/upload_images/6798179-d721ca39edb1430c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![](http://upload-images.jianshu.io/upload_images/6798179-6639400a6106cb7e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

åé¢å‡ æ­¥ç›´æ¥æŒ‰ç¡®å®šæ¥å—é»˜è®¤é€‰é¡¹å°±è¡Œäº†ã€‚å¦‚æœæƒ³åšæ›´é«˜çº§çš„é…ç½®è¿™é‡Œæœ‰æ›´è¯¦ç»†çš„è§£é‡Š [deploy-from-ansible.md](docs/deploy-from-ansible.md)ã€‚

å¥½äº†ï¼å¦‚æœæ²¡æœ‰å‡ºç°é—®é¢˜çš„è¯ï¼Œä½ å°±èƒ½å¾—åˆ°è‡ªå·±çš„VPNäº†ã€‚æœ€è¿‘ä¸€æ¬¡æµ‹è¯•ï¼Œæˆ‘å‘ç°åœ¨è‡ªåŠ¨æ­å»ºè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
TASK [cloud-digitalocean : Tag the droplet] ************************************
failed: [localhost] (item=staging) => {"failed": true, "item": "staging", "msg": "error tagging resource '73204383': param is missing or the value is empty: resources"}
failed: [localhost] (item=dbserver) => {"failed": true, "item": "dbserver", "msg": "error tagging resource '73204383': param is missing or the value is empty: resources"}
Debugger invoked
(debug) c
...
fatal: [localhost]: FAILED! => {"changed": false, "failed": true, "msg": "Failed as requested from task"}
```
 
[è§£å†³æ–¹æ³•](https://github.com/trailofbits/algo/issues/744)å¦‚ä¸‹ï¼Œå°†ä¸‹é¢çš„ä»£ç ä¿å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­`do_tag.patch`, ç„¶åè¿è¡Œ `patch -b -p0 < do_tag.patch`ã€‚
```
--- ./env/lib/python2.7/site-packages/ansible/modules/core/cloud/digital_ocean/digital_ocean_tag.py.orig	2017-12-02 09:42:56.044524930 -0500
+++ ./env/lib/python2.7/site-packages/ansible/modules/core/cloud/digital_ocean/digital_ocean_tag.py	2017-12-02 09:43:14.245074861 -0500
@@ -242,7 +242,7 @@
     module = AnsibleModule(
         argument_spec=dict(
             name=dict(type='str', required=True),
-            resource_id=dict(aliases=['droplet_id'], type='int'),
+            resource_id=dict(aliases=['droplet_id'], type='str'),
             resource_type=dict(choices=['droplet'], default='droplet'),
             state=dict(choices=['present', 'absent'], default='present'),
             api_token=dict(aliases=['API_TOKEN'], no_log=True),
```

å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œä¼šå¾—åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼Œç„¶åè®°ä¸‹ p12 (user certificate) çš„å¯†ç ï¼Œä¹‹åéœ€è¦ç”¨åˆ°ã€‚

```
        "\"#----------------------------------------------------------------------#\"",
        "\"#                          Congratulations!                            #\"",
        "\"#                     Your Algo server is running.                     #\"",
        "\"#    Config files and certificates are in the ./configs/ directory.    #\"",
        "\"#              Go to https://whoer.net/ after connecting               #\"",
        "\"#        and ensure that all your traffic passes through the VPN.      #\"",
        "\"#                    Local DNS resolver 172.16.0.1                     #\"",
        "\"#                The p12 and SSH keys password is XXXXXXXX             #\"",
        "\"#----------------------------------------------------------------------#\"",
```

## VPNçš„ä½¿ç”¨

ä½ éœ€è¦ç”¨åœ¨ `configs` è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œçš„æ–‡ä»¶æ¥è®¾ç½®æ‰‹æœºæˆ–è€…ç”µè„‘ä¸Šçš„VPN. æ‰€æœ‰çš„æ–‡ä»¶éƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆåœ¨ä»¥ Algo VPN æœåŠ¡å™¨çš„ IP åœ°å€å‘½åçš„æ–‡ä»¶å¤¹é‡Œã€‚ [å¦‚æœä¸çŸ¥é“æ€ä¹ˆç”¨è¿™äº›é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œæœ‰æ›´è¯¦ç»†çš„è§£é‡Šã€‚](https://github.com/trailofbits/algo#configure-the-vpn-clients) å› ä¸ºè¿™é‡Œæ–‡ç« é‡Œå·²ç»è®²å¾—å¾ˆæ¸…æ¥šäº†ï¼Œæˆ‘å°±ä¸ç¿»è¯‘äº†ã€‚

![](http://upload-images.jianshu.io/upload_images/6798179-a2d9181170e35ace.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)





